name: Scrape Calendar Data

on:
  schedule:
    - cron: "0 * * * *" # every hour
  workflow_dispatch:

permissions:
  contents: read

jobs:
  scrape-window-5:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        offset: [
            2,
            3,
            4,
            5,
            6,
            7,
            8,
            9,
            10,
            11,
            12,
            13,
            14,
            15,
            16,
            17,
            18,
            19,
          ] # 2 to 19
      max-parallel: 5
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      NORTHWESTERN_USERNAME: ${{ secrets.NORTHWESTERN_USERNAME }}
      NORTHWESTERN_PASSWORD: ${{ secrets.NORTHWESTERN_PASSWORD }}
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "pnpm" # cache keyed by pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright (Chromium only)
        run: pnpm --filter cron exec playwright install --with-deps chromium

      - name: Run scraper
        run: pnpm --filter cron scrape -- ${{ matrix.offset }}

  scrape-window-6:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        offset: [
            20,
            21,
            22,
            23,
            24,
            25,
            26,
            27,
            28,
            29,
            30,
            31,
            32,
            33,
            34,
            35,
            36,
            37,
            38,
            39,
          ] # 20 to 39
      max-parallel: 5
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      NORTHWESTERN_USERNAME: ${{ secrets.NORTHWESTERN_USERNAME }}
      NORTHWESTERN_PASSWORD: ${{ secrets.NORTHWESTERN_PASSWORD }}
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "pnpm" # cache keyed by pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright (Chromium only)
        run: pnpm --filter cron exec playwright install --with-deps chromium

      - name: Run scraper
        run: pnpm --filter cron scrape -- ${{ matrix.offset }}

  scrape-window-7:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        offset: [
            40,
            41,
            42,
            43,
            44,
            45,
            46,
            47,
            48,
            49,
            50,
            51,
            52,
            53,
            54,
            55,
            56,
            57,
            58,
            59,
          ] # 40 to 59
      max-parallel: 5
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      NORTHWESTERN_USERNAME: ${{ secrets.NORTHWESTERN_USERNAME }}
      NORTHWESTERN_PASSWORD: ${{ secrets.NORTHWESTERN_PASSWORD }}
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "pnpm" # cache keyed by pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright (Chromium only)
        run: pnpm --filter cron exec playwright install --with-deps chromium

      - name: Run scraper
        run: pnpm --filter cron scrape -- ${{ matrix.offset }}
  scrape-window-8:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        offset: [
            60,
            61,
            62,
            63,
            64,
            65,
            66,
            67,
            68,
            69,
            70,
            71,
            72,
            73,
            74,
            75,
            76,
            77,
            78,
            79,
          ] # 60 to 79
      max-parallel: 5
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      NORTHWESTERN_USERNAME: ${{ secrets.NORTHWESTERN_USERNAME }}
      NORTHWESTERN_PASSWORD: ${{ secrets.NORTHWESTERN_PASSWORD }}
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "pnpm" # cache keyed by pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright (Chromium only)
        run: pnpm --filter cron exec playwright install --with-deps chromium

      - name: Run scraper
        run: pnpm --filter cron scrape -- ${{ matrix.offset }}
